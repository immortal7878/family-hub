<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Family Hub">
<meta name="theme-color" content="#FFF8F0">
<meta name="description" content="Family Hub Command Center">
<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="icon-192.png">
<title>Family Hub</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:opsz,wght@9..40,400;9..40,500;9..40,600;9..40,700&family=Playfair+Display:wght@600;700;800&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #FFF8F0;
  --bg2: #F5F0E8;
  --card: #FFFBF5;
  --border: #F0EDE8;
  --border2: #E0DBD4;
  --text: #2D3436;
  --muted: #636E72;
  --faint: #B2BEC3;
  --serge: #E07A5F;
  --yulya: #81B29A;
  --alice: #F2CC8F;
  --matthew: #3D405B;
  --sat: env(safe-area-inset-top, 0px);
  --sab: env(safe-area-inset-bottom, 0px);
}

* { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
html, body { height: 100%; overflow: hidden; touch-action: manipulation; }
body {
  font-family: 'DM Sans', -apple-system, BlinkMacSystemFont, sans-serif;
  color: var(--text);
  background: var(--bg);
  overscroll-behavior: none;
  -webkit-font-smoothing: antialiased;
}

/* â”€â”€â”€ App Shell â”€â”€â”€ */
.app {
  display: flex; flex-direction: column;
  height: 100vh; height: 100dvh;
  position: relative;
}

/* â”€â”€â”€ Header â”€â”€â”€ */
.header {
  flex-shrink: 0;
  padding: calc(12px + var(--sat)) 20px 14px;
  background: var(--bg);
}
.header-row { display: flex; justify-content: space-between; align-items: center; }
.header h1 {
  font-family: 'Playfair Display', serif;
  font-size: 26px; font-weight: 800; letter-spacing: -0.5px;
}
.header .sub { color: var(--muted); font-size: 13px; margin-top: 2px; }
.avatars { display: flex; }
.avatar {
  width: 36px; height: 36px; border-radius: 50%;
  display: flex; align-items: center; justify-content: center;
  font-size: 17px; border: 2.5px solid var(--bg);
}
.avatar + .avatar { margin-left: -10px; }

/* â”€â”€â”€ Stats Row â”€â”€â”€ */
.stats {
  flex-shrink: 0;
  display: flex; gap: 8px; padding: 0 20px 14px;
}
.stat {
  flex: 1; background: var(--card); border-radius: 16px;
  padding: 10px 12px; border: 1px solid var(--border);
}
.stat-val {
  font-size: 22px; font-weight: 800;
  font-family: 'Playfair Display', serif; line-height: 1.1;
}
.stat-lbl {
  font-size: 9px; color: var(--faint); font-weight: 700;
  text-transform: uppercase; letter-spacing: 0.4px; margin-top: 2px;
}

/* â”€â”€â”€ Scrollable Content â”€â”€â”€ */
.scroll {
  flex: 1; overflow-y: auto; overflow-x: hidden;
  -webkit-overflow-scrolling: touch;
  padding: 0 16px 16px;
}
.card {
  background: var(--card); border-radius: 20px;
  padding: 18px; border: 1px solid var(--border);
}

/* â”€â”€â”€ Bottom Tab Bar (iOS style) â”€â”€â”€ */
.tab-bar {
  flex-shrink: 0;
  display: flex;
  background: rgba(255,248,240,0.92);
  backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
  border-top: 0.5px solid var(--border2);
  padding: 6px 0 calc(6px + var(--sab));
}
.tab {
  flex: 1; display: flex; flex-direction: column;
  align-items: center; justify-content: center;
  padding: 6px 0; border: none; background: none;
  font-family: 'DM Sans', sans-serif;
  font-size: 10px; font-weight: 600;
  color: var(--faint); cursor: pointer;
  transition: color 0.2s;
  gap: 3px;
}
.tab.active { color: var(--serge); }
.tab-ico {
  font-size: 22px; line-height: 1;
  transition: transform 0.2s;
}
.tab.active .tab-ico { transform: scale(1.12); }
.tab-dot {
  width: 4px; height: 4px; border-radius: 50%;
  background: var(--serge); opacity: 0;
  transition: opacity 0.2s;
}
.tab.active .tab-dot { opacity: 1; }

/* â”€â”€â”€ Calendar â”€â”€â”€ */
.cal-nav {
  display: flex; justify-content: space-between;
  align-items: center; margin-bottom: 12px;
}
.cal-title {
  font-family: 'Playfair Display', serif;
  font-size: 18px; font-weight: 700;
}
.nav-btn {
  width: 40px; height: 40px; border-radius: 50%;
  border: none; background: var(--border);
  font-size: 20px; color: var(--muted);
  display: flex; align-items: center; justify-content: center;
}
.nav-btn:active { background: var(--border2); transform: scale(0.92); }

.cal-grid {
  display: grid; grid-template-columns: repeat(7, 1fr);
  gap: 4px; margin-bottom: 8px;
}
.cal-head {
  text-align: center; font-size: 11px; font-weight: 700;
  color: var(--faint); padding: 6px 0;
  text-transform: uppercase; letter-spacing: 0.5px;
}
.cal-cell {
  aspect-ratio: 1; border-radius: 12px; padding: 3px;
  display: flex; flex-direction: column;
  align-items: center; justify-content: flex-start;
  position: relative; border: 1.5px solid transparent;
  background: #fff;
}
.cal-cell.empty { background: none; border: none; }
.cal-cell:not(.empty):active { background: var(--border); transform: scale(0.94); }
.cal-cell.today {
  border-color: var(--serge);
  background: rgba(224,122,95,0.08);
}
.cal-num {
  font-size: 13px; font-weight: 600; color: var(--muted);
  margin-top: 2px;
}
.cal-cell.today .cal-num { color: var(--serge); font-weight: 800; }
.cal-dots {
  display: flex; gap: 3px; margin-top: auto;
  padding-bottom: 3px;
}
.cal-dot-circle {
  width: 5px; height: 5px; border-radius: 50%;
}
.cal-more { font-size: 7px; color: var(--faint); font-weight: 700; }

.section-title {
  font-size: 13px; font-weight: 700; color: var(--faint);
  text-transform: uppercase; letter-spacing: 0.8px;
  margin: 14px 0 8px;
}
.ev-row {
  display: flex; align-items: center; gap: 12px;
  padding: 14px 16px; background: #fff; border-radius: 14px;
  margin-bottom: 6px; border: 1px solid var(--border);
}
.ev-row:active { background: var(--border); }
.ev-bar { width: 4px; height: 32px; border-radius: 2px; flex-shrink: 0; }
.ev-body { flex: 1; }
.ev-title { font-size: 15px; font-weight: 600; }
.ev-meta { font-size: 12px; color: var(--faint); margin-top: 1px; }
.del { background: none; border: none; font-size: 18px; color: var(--border2); padding: 8px; min-width: 36px; min-height: 36px; display: flex; align-items: center; justify-content: center; }
.del:active { color: var(--serge); }

/* â”€â”€â”€ Chores â”€â”€â”€ */
.prog-wrap { margin-bottom: 14px; }
.prog-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; }
.prog-text { font-size: 14px; color: var(--muted); font-weight: 500; }
.prog-bar { height: 8px; background: var(--border); border-radius: 4px; overflow: hidden; }
.prog-fill { height: 100%; background: var(--yulya); border-radius: 4px; transition: width 0.4s ease; }

.ch-row {
  display: flex; align-items: center; gap: 14px;
  padding: 14px 16px; background: #fff; border-radius: 14px;
  border: 1px solid var(--border); margin-bottom: 6px;
  transition: opacity 0.3s;
}
.ch-row.done { opacity: 0.45; }
.ch-box {
  width: 28px; height: 28px; border-radius: 8px;
  border: 2.5px solid; display: flex;
  align-items: center; justify-content: center;
  font-size: 16px; font-weight: 700; color: #fff;
  flex-shrink: 0; background: transparent;
  transition: all 0.2s;
}
.ch-box.checked { color: #fff; }
.ch-task { font-size: 15px; font-weight: 500; }
.ch-row.done .ch-task { text-decoration: line-through; color: var(--faint); }
.ch-sub { font-size: 12px; color: var(--faint); margin-top: 1px; }

/* â”€â”€â”€ Groceries â”€â”€â”€ */
.gr-cat {
  font-size: 12px; font-weight: 700; color: var(--faint);
  text-transform: uppercase; letter-spacing: 0.8px;
  margin: 12px 0 6px; padding-left: 4px;
}
.gr-row {
  display: flex; align-items: center; gap: 14px;
  padding: 14px 16px; background: #fff; border-radius: 14px;
  border: 1px solid var(--border); margin-bottom: 5px;
  transition: opacity 0.3s;
}
.gr-row.done { opacity: 0.4; }
.gr-circle {
  width: 26px; height: 26px; border-radius: 50%;
  border: 2.5px solid var(--yulya);
  display: flex; align-items: center; justify-content: center;
  font-size: 14px; color: #fff; flex-shrink: 0;
}
.gr-circle.checked { background: var(--yulya); }
.gr-name { flex: 1; font-size: 15px; font-weight: 500; }
.gr-row.done .gr-name { text-decoration: line-through; color: var(--faint); }
.gr-qty { font-size: 13px; color: var(--faint); }

/* â”€â”€â”€ Bulletin â”€â”€â”€ */
.notes-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
.note {
  border-radius: 16px; padding: 16px; min-height: 100px;
  position: relative; box-shadow: 0 2px 10px rgba(0,0,0,0.06);
}
.note-pin { position: absolute; top: 8px; right: 10px; font-size: 14px; }
.note-txt { font-size: 14px; line-height: 1.55; font-weight: 500; margin-bottom: 10px; }
.note-ft { display: flex; justify-content: space-between; align-items: center; }
.note-who { font-size: 12px; color: var(--muted); }
.note-acts { display: flex; gap: 4px; }
.note-acts button {
  background: none; border: none; font-size: 12px;
  opacity: 0.55; color: var(--text); padding: 6px;
  min-width: 36px; min-height: 36px;
}

/* â”€â”€â”€ FAB â”€â”€â”€ */
.fab {
  position: absolute; right: 20px; bottom: calc(76px + var(--sab));
  width: 56px; height: 56px; border-radius: 50%;
  background: var(--serge); color: #fff;
  border: none; font-size: 30px; font-weight: 300;
  box-shadow: 0 4px 20px rgba(224,122,95,0.45);
  display: flex; align-items: center; justify-content: center;
  z-index: 100; transition: transform 0.2s;
  line-height: 1;
}
.fab:active { transform: scale(0.88); }

/* â”€â”€â”€ Modal (bottom sheet) â”€â”€â”€ */
.overlay {
  position: fixed; inset: 0; z-index: 1000;
  background: rgba(0,0,0,0.35);
  backdrop-filter: blur(4px); -webkit-backdrop-filter: blur(4px);
}
.sheet {
  position: fixed; bottom: 0; left: 0; right: 0;
  background: var(--card); z-index: 1001;
  border-radius: 24px 24px 0 0;
  padding: 10px 24px calc(28px + var(--sab));
  max-height: 85vh; overflow-y: auto;
  box-shadow: 0 -12px 50px rgba(0,0,0,0.15);
  animation: sheetUp 0.32s cubic-bezier(0.32, 0.72, 0, 1);
}
.handle {
  width: 36px; height: 5px; border-radius: 3px;
  background: var(--border2); margin: 0 auto 18px;
}
.sheet-title {
  font-family: 'Playfair Display', serif;
  font-size: 22px; font-weight: 700; margin-bottom: 18px;
}
.field {
  width: 100%; padding: 14px 16px; border-radius: 14px;
  border: 1.5px solid var(--border2); font-size: 16px;
  font-family: 'DM Sans', sans-serif; outline: none;
  background: #fff; margin-bottom: 10px; color: var(--text);
  -webkit-appearance: none;
}
.field:focus { border-color: var(--serge); }
.field-ta { resize: none; min-height: 80px; }
.pills { display: flex; gap: 8px; flex-wrap: wrap; margin: 10px 0; }
.pill {
  padding: 10px 18px; border-radius: 22px;
  border: 2px solid; font-family: 'DM Sans', sans-serif;
  font-size: 14px; font-weight: 600;
  background: transparent; transition: all 0.2s;
}
.pill.on { color: #fff !important; }
.pill:active { transform: scale(0.95); }
.submit-btn {
  width: 100%; padding: 16px 0; border-radius: 16px;
  border: none; background: var(--serge); color: #fff;
  font-size: 17px; font-weight: 700; margin-top: 12px;
  font-family: 'DM Sans', sans-serif;
}
.submit-btn:active { background: #c9654b; transform: scale(0.98); }
.color-dots { display: flex; gap: 12px; margin: 10px 0; }
.cdot {
  width: 34px; height: 34px; border-radius: 50%;
  border: 3px solid transparent; transition: border 0.15s;
}
.cdot.on { border-color: var(--text); }

/* â”€â”€â”€ Toast â”€â”€â”€ */
.toast {
  position: fixed; top: calc(14px + var(--sat));
  left: 16px; right: 16px; z-index: 2000;
  background: var(--text); color: #fff;
  padding: 14px 20px; border-radius: 16px;
  font-size: 15px; font-weight: 600;
  box-shadow: 0 8px 30px rgba(0,0,0,0.3);
  display: flex; align-items: center; gap: 10px;
  animation: toastIn 0.35s ease, toastOut 0.3s ease 2.2s forwards;
}

@keyframes sheetUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
@keyframes toastIn { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
@keyframes toastOut { from { opacity: 1; } to { opacity: 0; transform: translateY(-20px); } }
</style>
</head>
<body>
<div id="app" class="app"></div>

<script>
const SK = "family_hub_v2";
const FAM = [
  { name: "Serge", color: "#E07A5F", emoji: "ðŸ‘¨" },
  { name: "Yulya", color: "#81B29A", emoji: "ðŸ‘©" },
  { name: "Alice", color: "#F2CC8F", emoji: "ðŸ‘§" },
  { name: "Matthew", color: "#3D405B", emoji: "ðŸ‘¦" },
];
const DAYS = ["S","M","T","W","T","F","S"];
const MO = ["January","February","March","April","May","June","July","August","September","October","November","December"];
const NCOL = ["#FFEAA7","#FAD9D5","#DFE6E9","#C8E6C9","#D1C4E9","#FFE0B2"];
const CATS = ["produce","dairy","meat","pantry","bakery","frozen","snacks","drinks"];

function seed() {
  const t = new Date();
  const d = o => { const x = new Date(t); x.setDate(x.getDate()+o); return x.toISOString().split("T")[0]; };
  return {
    events: [
      {id:1,title:"Tax Filing Deadline",date:d(4),member:"Serge"},
      {id:2,title:"School Play",date:d(2),member:"Alice"},
      {id:3,title:"Dentist Appointment",date:d(7),member:"Yulya"},
      {id:4,title:"Soccer Practice",date:d(0),member:"Alice"},
      {id:5,title:"Grocery Run",date:d(1),member:"Yulya"},
      {id:6,title:"Piano Lesson",date:d(3),member:"Matthew"},
    ],
    chores: [
      {id:1,task:"Take out trash",who:"Serge",done:false,freq:"weekly"},
      {id:2,task:"Load dishwasher",who:"Alice",done:true,freq:"daily"},
      {id:3,task:"Vacuum living room",who:"Yulya",done:false,freq:"weekly"},
      {id:4,task:"Make bed",who:"Matthew",done:true,freq:"daily"},
      {id:5,task:"Wipe counters",who:"Alice",done:false,freq:"daily"},
      {id:6,task:"Sort recycling",who:"Serge",done:false,freq:"weekly"},
    ],
    groceries: [
      {id:1,item:"Whole milk",qty:"1 gallon",ok:false,cat:"dairy"},
      {id:2,item:"Chicken breast",qty:"2 lbs",ok:false,cat:"meat"},
      {id:3,item:"Bananas",qty:"1 bunch",ok:true,cat:"produce"},
      {id:4,item:"Pasta",qty:"2 boxes",ok:false,cat:"pantry"},
      {id:5,item:"Cheddar cheese",qty:"1 block",ok:false,cat:"dairy"},
      {id:6,item:"Bread",qty:"1 loaf",ok:true,cat:"bakery"},
      {id:7,item:"Eggs",qty:"1 dozen",ok:false,cat:"dairy"},
      {id:8,item:"Broccoli",qty:"2 heads",ok:false,cat:"produce"},
    ],
    notes: [
      {id:1,text:"RSVP for Jake's birthday party by Friday!",who:"Yulya",pin:true,col:"#FFEAA7",ts:Date.now()-86400000},
      {id:2,text:"Plumber coming Thursday 2-4pm",who:"Serge",pin:true,col:"#DFE6E9",ts:Date.now()-43200000},
      {id:3,text:"New WiFi: SunnyDays2026!",who:"Serge",pin:false,col:"#FAD9D5",ts:Date.now()-172800000},
    ],
  };
}

let D, S={tab:"cal",modal:null,md:{},cm:new Date().getMonth(),cy:new Date().getFullYear()};
try{const s=localStorage.getItem(SK);D=s?JSON.parse(s):seed();}catch{D=seed();}
function save(){try{localStorage.setItem(SK,JSON.stringify(D));}catch{}}
function mem(n){return FAM.find(m=>m.name===n)||FAM[0];}
function tk(){const t=new Date();return`${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}-${String(t.getDate()).padStart(2,"0")}`;}
function dk(y,m,d){return`${y}-${String(m+1).padStart(2,"0")}-${String(d).padStart(2,"0")}`;}
function uid(){return Date.now()+Math.random();}

function h(tag,a,...ch){
  const el=document.createElement(tag);
  if(a)Object.entries(a).forEach(([k,v])=>{
    if(k==="style"&&typeof v==="object")Object.assign(el.style,v);
    else if(k.startsWith("on"))el.addEventListener(k.slice(2).toLowerCase(),v);
    else if(k==="className")el.className=v;
    else el.setAttribute(k,v);
  });
  ch.flat(99).forEach(c=>{if(c!=null&&c!==false)el.appendChild(typeof c==="string"||typeof c==="number"?document.createTextNode(c):c);});
  return el;
}

function render(){
  const app=document.getElementById("app");
  app.innerHTML="";
  app.appendChild(mkHeader());
  app.appendChild(mkStats());
  app.appendChild(mkScroll());
  app.appendChild(mkFab());
  app.appendChild(mkTabBar());
  if(S.modal){app.appendChild(mkOverlay());app.appendChild(mkSheet());}
}

function mkHeader(){
  const t=new Date(),hr=t.getHours();
  const g=hr<12?"Good morning":hr<18?"Good afternoon":"Good evening";
  return h("div",{className:"header"},
    h("div",{className:"header-row"},
      h("div",null,
        h("h1",null,"Family Hub"),
        h("p",{className:"sub"},`${g}, Serge`)
      ),
      h("div",{className:"avatars"},
        ...FAM.map((m,i)=>h("div",{className:"avatar",style:{background:m.color,zIndex:4-i}},m.emoji))
      )
    )
  );
}

function mkStats(){
  const today=tk();
  const evts=D.events.filter(e=>e.date===today).length;
  const chrs=D.chores.filter(c=>!c.done).length;
  const groc=D.groceries.filter(g=>!g.ok).length;
  return h("div",{className:"stats"},
    ...[
      {v:evts,l:"Today",c:"var(--serge)"},
      {v:chrs,l:"Chores",c:"var(--yulya)"},
      {v:groc,l:"Groceries",c:"var(--alice)"},
    ].map(s=>h("div",{className:"stat"},
      h("div",{className:"stat-val",style:{color:s.c}},String(s.v)),
      h("div",{className:"stat-lbl"},s.l)
    ))
  );
}

function mkScroll(){
  const w=h("div",{className:"scroll"});
  const c=h("div",{className:"card"});
  if(S.tab==="cal")c.appendChild(mkCal());
  else if(S.tab==="chores")c.appendChild(mkChores());
  else if(S.tab==="groc")c.appendChild(mkGroc());
  else c.appendChild(mkNotes());
  w.appendChild(c);
  return w;
}

function mkFab(){
  const labels={cal:"event",chores:"chore",groc:"grocery",board:"note"};
  return h("button",{className:"fab",onClick:()=>openModal(labels[S.tab])},"+");
}

function mkTabBar(){
  const tabs=[
    {key:"cal",icon:"ðŸ“…",label:"Calendar"},
    {key:"chores",icon:"âœ…",label:"Chores"},
    {key:"groc",icon:"ðŸ›’",label:"Groceries"},
    {key:"board",icon:"ðŸ“Œ",label:"Board"},
  ];
  return h("div",{className:"tab-bar"},
    ...tabs.map(t=>h("button",{
      className:"tab"+(S.tab===t.key?" active":""),
      onClick:()=>{S.tab=t.key;render();}
    },
      h("span",{className:"tab-ico"},t.icon),
      h("span",null,t.label),
      h("span",{className:"tab-dot"})
    ))
  );
}

// â”€â”€â”€ CALENDAR â”€â”€â”€
function mkCal(){
  const{cm:mo,cy:yr}=S;
  const fd=new Date(yr,mo,1).getDay();
  const dim=new Date(yr,mo+1,0).getDate();
  const today=tk();
  const em={};
  D.events.forEach(e=>{(em[e.date]=em[e.date]||[]).push(e);});
  const prev=()=>{if(mo===0){S.cm=11;S.cy--;}else S.cm--;render();};
  const next=()=>{if(mo===11){S.cm=0;S.cy++;}else S.cm++;render();};
  const f=h("div");
  f.appendChild(h("div",{className:"cal-nav"},
    h("button",{className:"nav-btn",onClick:prev},"â€¹"),
    h("span",{className:"cal-title"},`${MO[mo]} ${yr}`),
    h("button",{className:"nav-btn",onClick:next},"â€º")
  ));
  const g=h("div",{className:"cal-grid"});
  DAYS.forEach(d=>g.appendChild(h("div",{className:"cal-head"},d)));
  for(let i=0;i<fd;i++)g.appendChild(h("div",{className:"cal-cell empty"}));
  for(let day=1;day<=dim;day++){
    const key=dk(yr,mo,day);
    const isT=key===today;
    const evts=em[key]||[];
    const cell=h("div",{
      className:"cal-cell"+(isT?" today":""),
      onClick:()=>openModal("event",key)
    },h("div",{className:"cal-num"},String(day)));
    if(evts.length){
      const dots=h("div",{className:"cal-dots"});
      evts.slice(0,3).forEach(ev=>{
        dots.appendChild(h("div",{className:"cal-dot-circle",style:{background:mem(ev.member).color}}));
      });
      if(evts.length>3)dots.appendChild(h("span",{className:"cal-more"},`+${evts.length-3}`));
      cell.appendChild(dots);
    }
    g.appendChild(cell);
  }
  f.appendChild(g);
  const up=D.events.filter(e=>e.date>=today).sort((a,b)=>a.date.localeCompare(b.date)).slice(0,6);
  if(up.length){
    f.appendChild(h("div",{className:"section-title"},"Upcoming"));
    up.forEach(ev=>{
      const m=mem(ev.member);
      const lbl=ev.date===today?"Today":new Date(ev.date+"T12:00:00").toLocaleDateString("en-US",{weekday:"short",month:"short",day:"numeric"});
      f.appendChild(h("div",{className:"ev-row"},
        h("div",{className:"ev-bar",style:{background:m.color}}),
        h("div",{className:"ev-body"},
          h("div",{className:"ev-title"},ev.title),
          h("div",{className:"ev-meta"},`${lbl} Â· ${m.emoji} ${ev.member}`)
        ),
        h("button",{className:"del",onClick:()=>{D.events=D.events.filter(e=>e.id!==ev.id);save();render();}},"âœ•")
      ));
    });
  }
  return f;
}

// â”€â”€â”€ CHORES â”€â”€â”€
function mkChores(){
  const done=D.chores.filter(c=>c.done).length;
  const tot=D.chores.length;
  const pct=tot?done/tot*100:0;
  const f=h("div");
  f.appendChild(h("div",{className:"prog-wrap"},
    h("div",{className:"prog-row"},
      h("span",{className:"prog-text"},`${done} of ${tot} done`),
      h("span",{className:"prog-text",style:{color:"var(--yulya)",fontWeight:700}},`${Math.round(pct)}%`)
    ),
    h("div",{className:"prog-bar"},
      h("div",{className:"prog-fill",style:{width:pct+"%"}})
    )
  ));
  D.chores.forEach(c=>{
    const m=mem(c.who);
    f.appendChild(h("div",{className:"ch-row"+(c.done?" done":"")},
      h("div",{
        className:"ch-box"+(c.done?" checked":""),
        style:{borderColor:m.color,background:c.done?m.color:"transparent"},
        onClick:()=>{c.done=!c.done;save();render();}
      },c.done?"âœ“":""),
      h("div",{style:{flex:1}},
        h("div",{className:"ch-task"},c.task),
        h("div",{className:"ch-sub"},`${m.emoji} ${c.who} Â· ${c.freq}`)
      ),
      h("button",{className:"del",onClick:()=>{D.chores=D.chores.filter(x=>x.id!==c.id);save();render();}},"âœ•")
    ));
  });
  return f;
}

// â”€â”€â”€ GROCERIES â”€â”€â”€
function mkGroc(){
  const rem=D.groceries.filter(g=>!g.ok).length;
  const cats=[...new Set(D.groceries.map(g=>g.cat))];
  const f=h("div");
  f.appendChild(h("div",{style:{fontSize:"14px",color:"var(--muted)",marginBottom:"12px"}},`${rem} items to get`));
  cats.forEach(cat=>{
    const items=D.groceries.filter(g=>g.cat===cat);
    f.appendChild(h("div",{className:"gr-cat"},cat));
    items.forEach(item=>{
      f.appendChild(h("div",{className:"gr-row"+(item.ok?" done":"")},
        h("div",{
          className:"gr-circle"+(item.ok?" checked":""),
          onClick:()=>{item.ok=!item.ok;save();render();}
        },item.ok?"âœ“":""),
        h("div",{className:"gr-name"},item.item),
        h("span",{className:"gr-qty"},item.qty),
        h("button",{className:"del",onClick:()=>{D.groceries=D.groceries.filter(x=>x.id!==item.id);save();render();}},"âœ•")
      ));
    });
  });
  return f;
}

// â”€â”€â”€ BULLETIN â”€â”€â”€
function mkNotes(){
  const sorted=[...D.notes].sort((a,b)=>(b.pin?1:0)-(a.pin?1:0)||b.ts-a.ts);
  const f=h("div");
  const grid=h("div",{className:"notes-grid"});
  sorted.forEach(n=>{
    grid.appendChild(h("div",{className:"note",style:{background:n.col}},
      n.pin?h("span",{className:"note-pin"},"ðŸ“Œ"):"",
      h("p",{className:"note-txt"},n.text),
      h("div",{className:"note-ft"},
        h("span",{className:"note-who"},`â€” ${n.who}`),
        h("div",{className:"note-acts"},
          h("button",{onClick:()=>{n.pin=!n.pin;save();render();}},n.pin?"unpin":"pin"),
          h("button",{onClick:()=>{D.notes=D.notes.filter(x=>x.id!==n.id);save();render();}},"âœ•")
        )
      )
    ));
  });
  f.appendChild(grid);
  return f;
}

// â”€â”€â”€ MODAL â”€â”€â”€
function openModal(type,date){
  S.modal=type;
  if(type==="event")S.md={title:"",date:date||"",member:"Serge"};
  else if(type==="chore")S.md={task:"",who:"Serge",freq:"daily"};
  else if(type==="grocery")S.md={item:"",qty:"",cat:"produce"};
  else if(type==="note")S.md={text:"",who:"Serge",col:"#FFEAA7"};
  render();
  setTimeout(()=>{const inp=document.querySelector(".sheet .field");if(inp)inp.focus();},350);
}
function closeModal(){S.modal=null;render();}

function mkOverlay(){return h("div",{className:"overlay",onClick:closeModal});}

function mkSheet(){
  const md=S.md;
  const s=h("div",{className:"sheet"});
  s.appendChild(h("div",{className:"handle"}));

  if(S.modal==="event"){
    const dl=md.date?new Date(md.date+"T12:00:00").toLocaleDateString("en-US",{weekday:"long",month:"long",day:"numeric"}):"";
    s.appendChild(h("div",{className:"sheet-title"},md.date?`New Event Â· ${dl}`:"New Event"));
    s.appendChild(mkField("What's happening?",md.title,v=>md.title=v));
    if(!md.date)s.appendChild(mkField("",md.date,v=>md.date=v,"date"));
    s.appendChild(mkMemPills(md.member,v=>md.member=v));
    s.appendChild(h("button",{className:"submit-btn",onClick:()=>{
      if(!md.title||!md.date)return;
      D.events.push({id:uid(),title:md.title,date:md.date,member:md.member});
      save();notify(md.title,md.member);closeModal();
    }},"Add Event"));
  }else if(S.modal==="chore"){
    s.appendChild(h("div",{className:"sheet-title"},"New Chore"));
    s.appendChild(mkField("What needs doing?",md.task,v=>md.task=v));
    s.appendChild(mkMemPills(md.who,v=>md.who=v));
    s.appendChild(mkOptPills(["daily","weekly","monthly"],md.freq,v=>md.freq=v,"var(--matthew)"));
    s.appendChild(h("button",{className:"submit-btn",onClick:()=>{
      if(!md.task)return;
      D.chores.push({id:uid(),task:md.task,who:md.who,done:false,freq:md.freq});
      save();closeModal();
    }},"Add Chore"));
  }else if(S.modal==="grocery"){
    s.appendChild(h("div",{className:"sheet-title"},"Add Item"));
    s.appendChild(mkField("Item name",md.item,v=>md.item=v));
    s.appendChild(mkField("Quantity",md.qty,v=>md.qty=v));
    s.appendChild(mkOptPills(CATS,md.cat,v=>md.cat=v,"var(--alice)"));
    s.appendChild(h("button",{className:"submit-btn",onClick:()=>{
      if(!md.item)return;
      D.groceries.push({id:uid(),item:md.item,qty:md.qty,ok:false,cat:md.cat});
      save();closeModal();
    }},"Add Item"));
  }else if(S.modal==="note"){
    s.appendChild(h("div",{className:"sheet-title"},"Post a Note"));
    const ta=h("textarea",{className:"field field-ta",placeholder:"Write something...",onInput:e=>md.text=e.target.value});
    ta.value=md.text;
    s.appendChild(ta);
    s.appendChild(mkMemPills(md.who,v=>md.who=v));
    const dots=h("div",{className:"color-dots"});
    NCOL.forEach(c=>{
      dots.appendChild(h("div",{
        className:"cdot"+(md.col===c?" on":""),
        style:{background:c},
        onClick:()=>{md.col=c;render();setTimeout(()=>{const t2=document.querySelector(".sheet .field-ta");if(t2){t2.value=md.text;t2.focus();}},50);}
      }));
    });
    s.appendChild(dots);
    s.appendChild(h("button",{className:"submit-btn",onClick:()=>{
      if(!md.text)return;
      D.notes.unshift({id:uid(),text:md.text,who:md.who,pin:false,col:md.col,ts:Date.now()});
      save();closeModal();
    }},"Post Note"));
  }
  return s;
}

function mkField(ph,val,onChange,type){
  const inp=h("input",{className:"field",placeholder:ph,type:type||"text",onInput:e=>onChange(e.target.value)});
  inp.value=val;
  return inp;
}
function mkMemPills(sel,onChange){
  return h("div",{className:"pills"},
    ...FAM.map(m=>h("button",{
      className:"pill"+(sel===m.name?" on":""),
      style:{borderColor:m.color,color:sel===m.name?"#fff":m.color,background:sel===m.name?m.color:"transparent"},
      onClick:()=>{onChange(m.name);render();setTimeout(()=>{const inp=document.querySelector(".sheet .field");if(inp)inp.focus();},50);}
    },`${m.emoji} ${m.name}`))
  );
}
function mkOptPills(opts,sel,onChange,col){
  return h("div",{className:"pills"},
    ...opts.map(o=>h("button",{
      className:"pill"+(sel===o?" on":""),
      style:{borderColor:col,color:sel===o?"#fff":col,background:sel===o?col:"transparent"},
      onClick:()=>{onChange(o);render();}
    },o))
  );
}

// â”€â”€â”€ NOTIFICATIONS â”€â”€â”€
function notify(title,who){
  if(navigator.vibrate)navigator.vibrate([80,40,80]);
  try{
    const ctx=new(window.AudioContext||window.webkitAudioContext)();
    const n=(f,s,d)=>{const o=ctx.createOscillator(),g=ctx.createGain();o.type="sine";o.frequency.value=f;g.gain.setValueAtTime(0.25,ctx.currentTime+s);g.gain.exponentialRampToValueAtTime(0.01,ctx.currentTime+s+d);o.connect(g);g.connect(ctx.destination);o.start(ctx.currentTime+s);o.stop(ctx.currentTime+s+d);};
    n(523,0,0.12);n(659,0.1,0.12);n(784,0.2,0.2);
  }catch{}
  const toast=document.createElement("div");
  toast.className="toast";
  toast.textContent=`âœ…  "${title}" added for ${who}`;
  document.body.appendChild(toast);
  setTimeout(()=>toast.remove(),2600);
  if(Notification&&Notification.permission==="granted"){
    new Notification("Family Hub ðŸ ",{body:`"${title}" â€” ${who}`,icon:"icon-192.png"});
  }
}

render();
if("serviceWorker" in navigator)navigator.serviceWorker.register("sw.js").catch(()=>{});
if("Notification" in window&&Notification.permission==="default")Notification.requestPermission();
</script>
</body>
</html>
